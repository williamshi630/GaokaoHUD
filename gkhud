import json
import os
from datetime import datetime

# æ–‡ä»¶è·¯å¾„
SAVE_PATH = "game_schedule.json"
LOG_PATH = "daily_log.txt"

# åˆå§‹åŒ–è§’è‰²æ•°æ®
DEFAULT_DATA = {
    "character": {
        "name": "username",
        "level": 1,
        "exp": 0,
        "hp": 5
    },
    "tasks": {
        "main": [],
        "side": []
    }
}

# è¯»å–æ•°æ®
def load_data():
    if os.path.exists(SAVE_PATH):
        with open(SAVE_PATH, "r", encoding="utf-8") as f:
            return json.load(f)
    else:
        return DEFAULT_DATA

# ä¿å­˜æ•°æ®
def save_data(data):
    with open(SAVE_PATH, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

# æ˜¾ç¤ºè§’è‰²çŠ¶æ€
def show_status(data):
    char = data["character"]
    print("\n===== å½“å‰è§’è‰²çŠ¶æ€ =====")
    print(f"è§’è‰²å: {char['name']}")
    print(f"ç­‰çº§: {char['level']}")
    print(f"ç»éªŒå€¼: {char['exp']}")
    print(f"ç”Ÿå‘½å€¼: {'ğŸ§¡' * char['hp']}")
    print("========================")

# æ·»åŠ ä»»åŠ¡
def add_task(data, task_type):
    task_name = input(f"è¯·è¾“å…¥{'ä¸»çº¿' if task_type == 'main' else 'æ”¯çº¿'}ä»»åŠ¡åç§°: ")
    reward = int(input("è¯·è¾“å…¥ä»»åŠ¡å¥–åŠ±çš„ç»éªŒå€¼ (EXP): "))
    data["tasks"][task_type].append({"name": task_name, "reward": reward, "completed": False})
    print(f"ä»»åŠ¡ '{task_name}' å·²æ·»åŠ ï¼")

# æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
def show_tasks(data):
    print("\n===== ä»Šæ—¥ä»»åŠ¡ =====")
    for task_type, task_list in data["tasks"].items():
        print(f"{'ä¸»çº¿ä»»åŠ¡' if task_type == 'main' else 'æ”¯çº¿ä»»åŠ¡'}:")
        for i, task in enumerate(task_list, 1):
            status = "âœ…" if task["completed"] else "âŒ"
            print(f"  {i}. {task['name']} (å¥–åŠ±: {task['reward']} EXP) çŠ¶æ€: {status}")
    print("====================")

# å®Œæˆä»»åŠ¡
def complete_task(data):
    show_tasks(data)
    task_type = input("è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹ (main/side): ")
    task_index = int(input("è¯·é€‰æ‹©å®Œæˆçš„ä»»åŠ¡ç¼–å·: ")) - 1
    if 0 <= task_index < len(data["tasks"][task_type]):
        task = data["tasks"][task_type][task_index]
        if not task["completed"]:
            task["completed"] = True
            data["character"]["exp"] += task["reward"]
            print(f"ä»»åŠ¡ '{task['name']}' å®Œæˆï¼è·å¾— {task['reward']} EXPï¼")
            # æ£€æŸ¥æ˜¯å¦å‡çº§
            check_level_up(data)
        else:
            print("è¯¥ä»»åŠ¡å·²å®Œæˆï¼")
    else:
        print("ä»»åŠ¡ç¼–å·æ— æ•ˆï¼")

# æ£€æŸ¥è§’è‰²æ˜¯å¦å‡çº§
def check_level_up(data):
    char = data["character"]
    while char["exp"] >= char["level"] * 10:  # å‡çº§æ‰€éœ€ç»éªŒå€¼ = å½“å‰ç­‰çº§ * 10
        char["exp"] -= char["level"] * 10
        char["level"] += 1
        char["hp"] = min(char["hp"] + 1, 5)  # æ¯æ¬¡å‡çº§æ¢å¤ 1 ç‚¹ç”Ÿå‘½å€¼ï¼Œæœ€å¤§å€¼ä¸º 5
        print(f"æ­å–œï¼{char['name']} å‡çº§åˆ°ç­‰çº§ {char['level']}ï¼ç”Ÿå‘½å€¼æ¢å¤ 1 ç‚¹ï¼")

# ä¿®æ”¹è§’è‰²å
def change_character_name(data):
    new_name = input("è¯·è¾“å…¥æ–°çš„è§’è‰²å: ")
    data["character"]["name"] = new_name
    print(f"è§’è‰²åå·²ä¿®æ”¹ä¸º: {new_name}")

# ä¿å­˜æ¯æ—¥æ—¥å¿—
def save_daily_log(data):
    # è®¾ç½® Obsidian Vault çš„è·¯å¾„
    obsidian_vault_path = "/storage/emulated/0/Documents/é«˜è€ƒHUDæ—¥å¿—/"  # æ›¿æ¢ä¸ºä½ çš„ Obsidian Vault è·¯å¾„

    # ç¡®ä¿æ–‡ä»¶å¤¹å­˜åœ¨
    if not os.path.exists(obsidian_vault_path):
        os.makedirs(obsidian_vault_path)

    # è·å–å½“å‰æ—¥æœŸ
    today = datetime.now().strftime('%Y-%m-%d')
    file_name = f"é«˜è€ƒHUDæ—¥å¿—{today}.md"  # æ—¥å¿—æ–‡ä»¶å
    file_path = os.path.join(obsidian_vault_path, file_name)

    # å°†ä»»åŠ¡å’Œè§’è‰²çŠ¶æ€å†™å…¥ Markdown æ ¼å¼
    with open(file_path, "w", encoding="utf-8") as f:
        f.write(f"# {today} å­¦ä¹ æ—¥å¿—\n\n")

        for task_type, task_list in data["tasks"].items():
            f.write(f"## {'ä¸»çº¿ä»»åŠ¡' if task_type == 'main' else 'æ”¯çº¿ä»»åŠ¡'}\n")
            for task in task_list:
                status = "å®Œæˆ" if task["completed"] else "æœªå®Œæˆ"
                f.write(f"- **{task['name']}** - çŠ¶æ€: {status} (å¥–åŠ±: {task['reward']} EXP)\n")

        char = data["character"]
        f.write(f"\n### è§’è‰²çŠ¶æ€\n")
        f.write(f"ç­‰çº§: {char['level']}, ç»éªŒå€¼: {char['exp']}, ç”Ÿå‘½å€¼: {'ğŸ§¡' * char['hp']}\n")

    print(f"æ—¥å¿—å·²ä¿å­˜ä¸º {file_path}")

# ç¡®è®¤é€€å‡º
def confirm_exit():
    choice = input("æ‚¨ç¡®å®šè¦é€€å‡ºå—? (y/n): ")
    if choice.lower() == "y":
        print("ç¨‹åºé€€å‡ºï¼")
        return True
    else:
        print("å–æ¶ˆé€€å‡ºï¼Œç»§ç»­æ‰§è¡Œï¼")
        return False

# ç¡®è®¤æ˜¯å¦æ‰§è¡Œæ“ä½œ
def confirm_action(action_name):
    choice = input(f"æ‚¨ç¡®å®šè¦æ‰§è¡Œ'{action_name}'æ“ä½œå—? (y/n): ")
    if choice.lower() == "y":
        return True
    else:
        print(f"'{action_name}' æ“ä½œå·²å–æ¶ˆï¼")
        return False

# ä¸»èœå•
def main():
    data = load_data()
    while True:
        print("\n===== é«˜è€ƒHUD =====")
        print("1. æŸ¥çœ‹è§’è‰²çŠ¶æ€")
        print("2. æ·»åŠ ä¸»çº¿ä»»åŠ¡")
        print("3. æ·»åŠ æ”¯çº¿ä»»åŠ¡")
        print("4. æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨")
        print("5. å®Œæˆä»»åŠ¡")
        print("6. ä¿®æ”¹è§’è‰²å")
        print("7. ä¿å­˜æ¯æ—¥æ—¥å¿—å¹¶é€€å‡º")
        print("8. é€€å‡ºç¨‹åº")
        choice = input("è¯·é€‰æ‹©åŠŸèƒ½: ")

        if choice == "1":
            if confirm_action("æŸ¥çœ‹è§’è‰²çŠ¶æ€"):
                show_status(data)
        elif choice == "2":
            if confirm_action("æ·»åŠ ä¸»çº¿ä»»åŠ¡"):
                add_task(data, "main")
        elif choice == "3":
            if confirm_action("æ·»åŠ æ”¯çº¿ä»»åŠ¡"):
                add_task(data, "side")
        elif choice == "4":
            if confirm_action("æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨"):
                show_tasks(data)
        elif choice == "5":
            if confirm_action("å®Œæˆä»»åŠ¡"):
                complete_task(data)
        elif choice == "6":
            if confirm_action("ä¿®æ”¹è§’è‰²å"):
                change_character_name(data)
        elif choice == "7":
            if confirm_action("ä¿å­˜æ¯æ—¥æ—¥å¿—å¹¶é€€å‡º"):
                save_daily_log(data)
                save_data(data)
                print("è¿›åº¦å·²ä¿å­˜ï¼Œé€€å‡ºç¨‹åºï¼")
                break
        elif choice == "8":
            if confirm_action("é€€å‡ºç¨‹åº"):
                break
        else:
            print("æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°é€‰æ‹©ï¼")

if __name__ == "__main__":
    main()


